<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Truck Net Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { background-color: #1e1e1e; color: #fff; font-family: sans-serif; max-width: 700px; margin: auto; padding: 20px; }
    input, button { width: 100%; padding: 10px; margin-top: 10px; font-size: 16px; background-color: #2c2c2c; color: #fff; border: 1px solid #444; border-radius: 4px; }
    button { background-color: #444; cursor: pointer; }
    .hidden { display: none; }
    ul { padding-left: 20px; }
  </style>
</head>
<body>
  <h1>Truck Net Calculator</h1>
  <div id="loginSection">
    <input id="username" placeholder="Name" />
    <input id="pin" placeholder="PIN (4 digits)" maxlength="4" />
    <button id="loginBtn">Login</button>
  </div>
  <div id="appSection" class="hidden">
    <h2 id="welcome"></h2>
    <input id="fromInput" placeholder="From" list="fromInput-list" />
    <datalist id="fromInput-list"></datalist>
    <input id="toInput" placeholder="To" list="toInput-list" />
    <datalist id="toInput-list"></datalist>
    <button id="calcDistance">Calculate Distance</button>
    <input id="miles" placeholder="Miles" readonly />
    <input id="rate" placeholder="Load Rate ($)" />
    <div style="display: flex; gap: 10px;">
      <input id="fuelPrice" placeholder="Fuel Price ($/gal)" />
      <button id="updateDiesel">Update Diesel Price</button>
    </div>
    <input id="expenses" placeholder="Other Expenses ($)" />
    <button onclick="calculate()">Calculate Profit</button>
    <div id="result" class="hidden"></div>
    <button id="saveBtn" class="hidden" onclick="saveLoad()">Save Load</button>
    <button onclick="exportCSV()">Export to CSV</button>
    <div id="history" class="hidden">
      <h3>Saved Loads:</h3>
      <ul id="loadList"></ul>
    </div>
  </div>

  <script>
    async function updateDieselPrice() {
      const url = `https://api.eia.gov/v2/petroleum/pri/gnd/data/?api_key=Vr7yY3TlG39qALlIx4mgKtKanPlff6xSsWWS6sm5&frequency=weekly&data[0]=value&facets[product][]=EPD2D&facets[area][]=NUS&sort[0][column]=period&sort[0][direction]=desc&offset=0&length=1`;
      try {
        const res = await fetch(url);
        const data = await res.json();
        const latest = data?.response?.data?.[0]?.value;
        if (latest) {
          document.getElementById("fuelPrice").value = latest;
          alert("Diesel price updated: $" + latest);
        } else {
          alert("Could not retrieve price.");
        }
      } catch (e) {
        alert("Error fetching diesel price.");
      }
    }

    async function getCoordinates(location) {
      const url = `https://nominatim.openstreetmap.org/search?countrycodes=us&format=json&q=${encodeURIComponent(location)}`;
      const res = await fetch(url);
      const data = await res.json();
      return data[0] ? { lat: data[0].lat, lon: data[0].lon } : null;
    }

    async function calculateDistance() {
      const from = document.getElementById("fromInput").value;
      const to = document.getElementById("toInput").value;
      if (!from || !to) return;

      const fromCoord = await getCoordinates(from);
      const toCoord = await getCoordinates(to);
      if (!fromCoord || !toCoord) return alert("Unable to find one of the locations.");

      const routeUrl = `https://router.project-osrm.org/route/v1/driving/${fromCoord.lon},${fromCoord.lat};${toCoord.lon},${toCoord.lat}?overview=false`;
      const res = await fetch(routeUrl);
      const data = await res.json();

      const distanceMeters = data.routes?.[0]?.distance || 0;
      const distanceMiles = distanceMeters / 1609.34;
      document.getElementById("miles").value = distanceMiles.toFixed(1);
    }

    function autocomplete(inputId) {
      const input = document.getElementById(inputId);
      input.addEventListener("input", () => {
        const query = input.value;
        if (query.length < 2) return;
        fetch(`https://nominatim.openstreetmap.org/search?countrycodes=us&format=json&q=${encodeURIComponent(query)}`)
          .then(res => res.json())
          .then(data => {
            const datalist = document.getElementById(inputId + "-list");
            datalist.innerHTML = "";
            data.forEach(item => {
              const option = document.createElement("option");
              option.value = item.display_name;
              datalist.appendChild(option);
            });
          });
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("loginBtn").addEventListener("click", () => {
        const username = document.getElementById("username").value.trim();
        const pin = document.getElementById("pin").value.trim();
        if (username === "" || pin.length !== 4) return alert("Enter valid name and PIN.");
        document.getElementById("loginSection").classList.add("hidden");
        document.getElementById("appSection").classList.remove("hidden");
        document.getElementById("welcome").innerText = "Welcome, " + username + "!";
      });
      document.getElementById("calcDistance").addEventListener("click", calculateDistance);
      document.getElementById("updateDiesel").addEventListener("click", updateDieselPrice);
      autocomplete("fromInput");
      autocomplete("toInput");
    });

    function calculate() {
      const rate = parseFloat(document.getElementById("rate").value) || 0;
      const miles = parseFloat(document.getElementById("miles").value) || 0;
      const fuelPrice = parseFloat(document.getElementById("fuelPrice").value) || 0;
      const expenses = parseFloat(document.getElementById("expenses").value) || 0;
      const mpg = 6.2;
      const dispatcher = rate * 0.10;
      const fuel = (miles / mpg) * fuelPrice;
      const total = dispatcher + fuel + expenses;
      const profit = rate - total;

      document.getElementById("result").classList.remove("hidden");
      document.getElementById("result").innerHTML = `
        <p>Dispatcher: $${dispatcher.toFixed(2)}</p>
        <p>Fuel: $${fuel.toFixed(2)}</p>
        <p>Total Expenses: $${total.toFixed(2)}</p>
        <p><strong>Net Profit: $${profit.toFixed(2)}</strong></p>`;
      document.getElementById("saveBtn").classList.remove("hidden");
    }

    function saveLoad() {
      alert("Saving to Supabase not included in this test version.");
    }

    function exportCSV() {
      alert("CSV export not implemented yet.");
    }
  </script>
</body>
</html>
