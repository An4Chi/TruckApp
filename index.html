<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Truck Net Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      background-color: #1e1e1e;
      color: #ffffff;
      font-family: sans-serif;
      max-width: 700px;
      margin: auto;
      padding: 20px;
    }
    input, button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      font-size: 16px;
      background-color: #2c2c2c;
      color: #ffffff;
      border: 1px solid #444;
      border-radius: 4px;
    }
    button {
      background-color: #444;
      cursor: pointer;
    }
    .hidden {
      display: none;
    }
    ul.suggestions {
      background-color: #2c2c2c;
      list-style: none;
      padding: 0;
      margin: 0;
      border: 1px solid #555;
      max-height: 150px;
      overflow-y: auto;
    }
    ul.suggestions li {
      padding: 8px;
      cursor: pointer;
    }
    ul.suggestions li:hover {
      background-color: #555;
    }
  </style>
</head>
<body>
  <h1>Truck Net Calculator</h1>

  <div id="loginSection">
    <input id="username" placeholder="Name" />
    <input id="pin" placeholder="PIN (4 digits)" maxlength="4" />
    <button onclick="login()">Login</button>
  </div>

  <div id="appSection" class="hidden">
    <h2 id="welcome"></h2>

    <label>From:</label>
    <input id="fromInput" autocomplete="off" />
    <ul id="fromSuggestions" class="suggestions hidden"></ul>

    <label>To:</label>
    <input id="toInput" autocomplete="off" />
    <ul id="toSuggestions" class="suggestions hidden"></ul>

    <button onclick="calculateDistance()">Calculate Distance</button>
    <input id="miles" placeholder="Miles" readonly />

    <input id="rate" placeholder="Load Rate ($)" />
    <div style="display: flex; gap: 10px;">
      <input id="fuelPrice" placeholder="Fuel Price ($/gal)" style="flex: 1;" />
      <button onclick="updateDieselPrice()" style="flex: 1;">Update Diesel Price</button>
    </div>
    <input id="expenses" placeholder="Other Expenses ($)" />
    <button onclick="calculate()">Calculate Profit</button>
    <div id="result" class="hidden"></div>
    <button id="saveBtn" class="hidden" onclick="saveLoad()">Save Load</button>
    <button onclick="exportCSV()">Export to CSV</button>
  </div>

  <script>
    let currentUser = "";
    let coords = { from: null, to: null };

    function login() {
      const name = document.getElementById("username").value.trim();
      const pin = document.getElementById("pin").value.trim();
      if (name === "" || pin.length !== 4) return alert("Enter valid name and PIN.");
      currentUser = name + "_" + pin;
      document.getElementById("loginSection").classList.add("hidden");
      document.getElementById("appSection").classList.remove("hidden");
      document.getElementById("welcome").innerText = "Welcome, " + name + "!";
    }

    function updateDieselPrice() {
      fetch("https://api.eia.gov/series/?api_key=DEMO_KEY&series_id=PET.EMD_EPD2D_PTE_NUS_DPG.W")
        .then(res => res.json())
        .then(data => {
          const latest = data.series[0].data[0][1];
          document.getElementById("fuelPrice").value = latest;
        })
        .catch(() => {
          alert("Failed to fetch diesel price. Please enter manually.");
        });
    }

    async function autocomplete(field) {
      const input = document.getElementById(field + "Input");
      const list = document.getElementById(field + "Suggestions");
      const query = input.value.trim();
      list.innerHTML = "";
      list.classList.remove("hidden");
      if (query.length < 2) return;

      const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
      const data = await res.json();
      data.forEach(item => {
        const li = document.createElement("li");
        li.textContent = item.display_name;
        li.onclick = () => {
          input.value = item.display_name;
          coords[field] = [item.lon, item.lat];
          list.classList.add("hidden");
        };
        list.appendChild(li);
      });
    }

    document.getElementById("fromInput").addEventListener("input", () => autocomplete("from"));
    document.getElementById("toInput").addEventListener("input", () => autocomplete("to"));

    function calculateDistance() {
      if (!coords.from || !coords.to) return alert("Select both locations.");
      const url = `https://router.project-osrm.org/route/v1/driving/${coords.from[0]},${coords.from[1]};${coords.to[0]},${coords.to[1]}?overview=false`;
      fetch(url)
        .then(res => res.json())
        .then(data => {
          const miles = (data.routes[0].distance / 1609.34).toFixed(2);
          document.getElementById("miles").value = miles;
        })
        .catch(() => alert("Failed to calculate distance."));
    }

    function calculate() {
      const rate = parseFloat(document.getElementById("rate").value);
      const miles = parseFloat(document.getElementById("miles").value);
      const fuelPrice = parseFloat(document.getElementById("fuelPrice").value);
      const expenses = parseFloat(document.getElementById("expenses").value);
      const mpg = 6.2;
      const dispatcher = rate * 0.10;
      const fuel = (miles / mpg) * fuelPrice;
      const total = dispatcher + fuel + expenses;
      const profit = rate - total;

      document.getElementById("result").classList.remove("hidden");
      document.getElementById("result").innerHTML = `
        <p>Dispatcher: $${dispatcher.toFixed(2)}</p>
        <p>Fuel: $${fuel.toFixed(2)}</p>
        <p>Total Expenses: $${total.toFixed(2)}</p>
        <p><strong>Net Profit: $${profit.toFixed(2)}</strong></p>`;
      document.getElementById("saveBtn").classList.remove("hidden");
    }

    function saveLoad() {
      const history = JSON.parse(localStorage.getItem(currentUser) || "[]");
      const entry = {
        date: new Date().toLocaleString(),
        from: document.getElementById("fromInput").value,
        to: document.getElementById("toInput").value,
        rate: document.getElementById("rate").value,
        miles: document.getElementById("miles").value,
        fuelPrice: document.getElementById("fuelPrice").value,
        expenses: document.getElementById("expenses").value
      };
      history.push(entry);
      localStorage.setItem(currentUser, JSON.stringify(history));
      alert("Load saved.");
    }

    function exportCSV() {
      const history = JSON.parse(localStorage.getItem(currentUser) || "[]");
      if (!history.length) return alert("No data to export.");
      const header = "Date,From,To,Rate,Miles,Fuel Price,Expenses\n";
      const rows = history.map(e => 
        [e.date, e.from, e.to, e.rate, e.miles, e.fuelPrice, e.expenses].join(",")
      ).join("\n");
      const csv = "data:text/csv;charset=utf-8," + header + rows;
      const link = document.createElement("a");
      link.setAttribute("href", encodeURI(csv));
      link.setAttribute("download", "truck_loads_export.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  </script>
</body>
</html>
